<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Chat Android</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
}

body {
  font-family: 'Roboto', -apple-system, sans-serif;
  background: #fff;
  color: #333;
  height: 100vh;
  overflow: hidden;
  -webkit-font-smoothing: antialiased;
}

/* Pantalla de Login - Optimizada para Android */
#loginScreen {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  padding: 20px;
}

.login-container {
  width: 100%;
  max-width: 400px;
  background: rgba(255, 255, 255, 0.95);
  border-radius: 16px;
  padding: 30px 25px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.2);
  backdrop-filter: blur(10px);
}

.login-title {
  text-align: center;
  font-size: 24px;
  font-weight: 500;
  margin-bottom: 25px;
  color: #333;
}

/* Tabs optimizadas para toque */
.auth-tabs {
  display: flex;
  margin-bottom: 25px;
  background: #f5f5f5;
  border-radius: 12px;
  padding: 4px;
}

.tab-btn {
  flex: 1;
  padding: 14px 10px;
  border: none;
  background: transparent;
  font-size: 16px;
  color: #666;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.2s;
  font-weight: 500;
}

.tab-btn.active {
  background: #fff;
  color: #667eea;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* Inputs optimizados para Android */
.input-group {
  margin-bottom: 20px;
}

.input-field {
  width: 100%;
  padding: 16px;
  border: 2px solid #e0e0e0;
  border-radius: 12px;
  font-size: 16px;
  background: #fff;
  transition: border-color 0.2s;
  -webkit-appearance: none;
}

.input-field:focus {
  outline: none;
  border-color: #667eea;
}

.input-field::placeholder {
  color: #999;
}

/* Botones grandes para toque */
.btn {
  width: 100%;
  padding: 18px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  border-radius: 12px;
  font-size: 17px;
  font-weight: 500;
  cursor: pointer;
  transition: transform 0.1s, opacity 0.2s;
  margin-top: 10px;
  -webkit-user-select: none;
  user-select: none;
}

.btn:active {
  transform: scale(0.98);
  opacity: 0.9;
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

/* CAPTCHA optimizado para m√≥vil */
.captcha-container {
  background: #f8f9fa;
  border-radius: 12px;
  padding: 15px;
  margin: 20px 0;
  border: 2px solid #e0e0e0;
}

.captcha-code {
  font-family: 'Courier New', monospace;
  font-size: 28px;
  font-weight: bold;
  letter-spacing: 8px;
  text-align: center;
  margin-bottom: 15px;
  color: #333;
  background: #fff;
  padding: 12px;
  border-radius: 8px;
  user-select: none;
}

.captcha-input {
  width: 100%;
  padding: 16px;
  font-size: 18px;
  text-align: center;
  border: 2px solid #ddd;
  border-radius: 12px;
  margin-bottom: 10px;
}

.refresh-btn {
  width: 100%;
  padding: 12px;
  background: #6c757d;
  color: white;
  border: none;
  border-radius: 10px;
  font-size: 15px;
  cursor: pointer;
}

/* Mensajes de error/success */
.alert {
  padding: 12px;
  border-radius: 10px;
  margin-top: 15px;
  font-size: 14px;
  text-align: center;
  display: none;
}

.error {
  background: #fee;
  color: #dc3545;
  border: 1px solid #fcc;
}

.success {
  background: #d4edda;
  color: #155724;
  border: 1px solid #c3e6cb;
}

.hidden {
  display: none !important;
}

/* ===== CHAT PRINCIPAL ===== */
#chatScreen {
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
  background: #fff;
}

/* Header estilo Android */
.chat-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  padding: 15px 20px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  color: white;
  min-height: 60px;
}

.header-title {
  font-size: 20px;
  font-weight: 500;
}

.user-status {
  display: flex;
  align-items: center;
  gap: 10px;
}

.online-badge {
  background: rgba(255,255,255,0.2);
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 14px;
  display: flex;
  align-items: center;
  gap: 5px;
}

.user-avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: rgba(255,255,255,0.2);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 16px;
}

.logout-btn {
  background: rgba(255,255,255,0.2);
  border: none;
  color: white;
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 14px;
  cursor: pointer;
  margin-left: 10px;
}

/* √Årea de mensajes optimizada para scroll t√°ctil */
.messages-container {
  flex: 1;
  overflow-y: auto;
  padding: 15px;
  background: #f5f5f5;
  -webkit-overflow-scrolling: touch;
}

.message {
  margin-bottom: 16px;
  max-width: 85%;
  animation: fadeIn 0.3s ease;
}

.message.own {
  margin-left: auto;
}

.message-bubble {
  padding: 12px 16px;
  border-radius: 18px;
  background: white;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  line-height: 1.4;
  font-size: 16px;
  word-wrap: break-word;
}

.message.own .message-bubble {
  background: #667eea;
  color: white;
  border-bottom-right-radius: 5px;
}

.message.other .message-bubble {
  border-bottom-left-radius: 5px;
}

.message-info {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 4px;
  padding: 0 5px;
}

.message-sender {
  font-weight: 500;
  font-size: 14px;
}

.message-time {
  font-size: 12px;
  color: #666;
  opacity: 0.8;
}

.message.own .message-time {
  color: rgba(255,255,255,0.8);
}

/* Input area optimizada para teclado virtual */
.input-area {
  padding: 15px;
  background: #fff;
  border-top: 1px solid #e0e0e0;
  display: flex;
  gap: 10px;
  align-items: flex-end;
  min-height: 70px;
}

.message-input {
  flex: 1;
  padding: 14px;
  border: 2px solid #e0e0e0;
  border-radius: 25px;
  font-size: 16px;
  resize: none;
  max-height: 120px;
  min-height: 50px;
  line-height: 1.4;
  -webkit-appearance: none;
}

.message-input:focus {
  outline: none;
  border-color: #667eea;
}

.send-btn {
  width: 50px;
  height: 50px;
  background: #667eea;
  color: white;
  border: none;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  transition: transform 0.1s;
  flex-shrink: 0;
}

.send-btn:active {
  transform: scale(0.95);
}

/* Scrollbar optimizada para t√°ctil */
.messages-container::-webkit-scrollbar {
  width: 5px;
}

.messages-container::-webkit-scrollbar-track {
  background: #f1f1f1;
}

.messages-container::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 2.5px;
}

.messages-container::-webkit-scrollbar-thumb:hover {
  background: #a8a8a8;
}

/* Animaciones suaves */
@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Status bar simulator (opcional) */
.status-bar {
  height: env(safe-area-inset-top, 0px);
  background: #5a6fd8;
  width: 100%;
}

/* Safe area para iPhone X+ */
@supports (padding: max(0px)) {
  .chat-header,
  .input-area {
    padding-left: max(15px, env(safe-area-inset-left));
    padding-right: max(15px, env(safe-area-inset-right));
  }
  
  .input-area {
    padding-bottom: max(15px, env(safe-area-inset-bottom));
  }
}

/* Keyboard avoidance */
.keyboard-open .messages-container {
  padding-bottom: 300px;
}

/* Loading spinner */
.spinner {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 3px solid rgba(255,255,255,.3);
  border-radius: 50%;
  border-top-color: #fff;
  animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Optimizaci√≥n para diferentes densidades de pantalla */
@media (max-height: 600px) {
  .login-container {
    padding: 20px 15px;
  }
  
  .btn {
    padding: 15px;
  }
  
  .input-field {
    padding: 14px;
  }
}

/* Detecci√≥n de pantalla peque√±a */
@media (max-width: 360px) {
  .message {
    max-width: 90%;
  }
  
  .chat-header {
    padding: 12px 15px;
  }
  
  .login-container {
    padding: 20px 15px;
  }
}

/* Modo oscuro autom√°tico */
@media (prefers-color-scheme: dark) {
  body {
    background: #121212;
    color: #fff;
  }
  
  .login-container {
    background: rgba(30, 30, 30, 0.95);
    color: #fff;
  }
  
  .messages-container {
    background: #1e1e1e;
  }
  
  .message-bubble {
    background: #2d2d2d;
    color: #fff;
  }
  
  .input-area {
    background: #1e1e1e;
    border-top-color: #333;
  }
  
  .message-input {
    background: #2d2d2d;
    color: #fff;
    border-color: #444;
  }
  
  .input-field {
    background: #2d2d2d;
    color: #fff;
    border-color: #444;
  }
  
  .auth-tabs {
    background: #2d2d2d;
  }
  
  .tab-btn.active {
    background: #3d3d3d;
  }
}
</style>
</head>
<body>

<!-- Status Bar Simulator -->
<div class="status-bar"></div>

<!-- Pantalla de Login -->
<div id="loginScreen">
  <div class="login-container">
    <h1 class="login-title">üí¨ Chat</h1>
    
    <div class="auth-tabs">
      <button class="tab-btn active" id="loginTab">INICIAR SESI√ìN</button>
      <button class="tab-btn" id="registerTab">REGISTRARSE</button>
    </div>
    
    <!-- Formulario Login -->
    <div id="loginForm">
      <div class="input-group">
        <input type="text" id="loginUser" class="input-field" placeholder="Usuario" autocapitalize="none" autocomplete="username" />
      </div>
      
      <div class="input-group">
        <input type="password" id="loginPass" class="input-field" placeholder="Contrase√±a" autocomplete="current-password" />
      </div>
      
      <div class="captcha-container">
        <div class="captcha-code" id="captchaDisplay">ABCDE</div>
        <input type="text" id="captchaInput" class="captcha-input" placeholder="C√≥digo de seguridad" autocapitalize="characters" />
        <button class="refresh-btn" id="refreshCaptcha">üîÑ Nuevo c√≥digo</button>
      </div>
      
      <button id="loginBtn" class="btn">
        <span id="loginText">ENTRAR AL CHAT</span>
        <span id="loginSpinner" class="spinner hidden"></span>
      </button>
      <div id="loginError" class="alert error"></div>
    </div>
    
    <!-- Formulario Registro -->
    <div id="registerForm" class="hidden">
      <div class="input-group">
        <input type="text" id="registerUser" class="input-field" placeholder="Usuario" autocapitalize="none" autocomplete="username" />
      </div>
      
      <div class="input-group">
        <input type="password" id="registerPass" class="input-field" placeholder="Contrase√±a" autocomplete="new-password" />
      </div>
      
      <div class="input-group">
        <input type="password" id="registerConfirm" class="input-field" placeholder="Confirmar contrase√±a" autocomplete="new-password" />
      </div>
      
      <div class="captcha-container">
        <div class="captcha-code" id="registerCaptchaDisplay">FGHIJ</div>
        <input type="text" id="registerCaptchaInput" class="captcha-input" placeholder="C√≥digo de seguridad" autocapitalize="characters" />
        <button class="refresh-btn" id="refreshRegisterCaptcha">üîÑ Nuevo c√≥digo</button>
      </div>
      
      <button id="registerBtn" class="btn">
        <span id="registerText">CREAR CUENTA</span>
        <span id="registerSpinner" class="spinner hidden"></span>
      </button>
      <div id="registerError" class="alert error"></div>
      <div id="registerSuccess" class="alert success"></div>
    </div>
  </div>
</div>

<!-- Pantalla del Chat -->
<div id="chatScreen" class="hidden">
  <div class="chat-header">
    <div class="header-title">üí¨ Chat</div>
    <div class="user-status">
      <div class="online-badge">
        <span>üë•</span>
        <span id="onlineCount">0</span>
      </div>
      <div class="user-avatar" id="userBadge">U</div>
      <button class="logout-btn" id="logoutBtn">Salir</button>
    </div>
  </div>
  
  <div class="messages-container" id="messagesContainer">
    <!-- Mensajes se cargan aqu√≠ -->
  </div>
  
  <div class="input-area">
    <textarea 
      id="messageInput" 
      class="message-input" 
      placeholder="Escribe un mensaje..." 
      rows="1"
      enterkeyhint="send"
    ></textarea>
    <button id="sendBtn" class="send-btn">‚û§</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

<script>
// ================= CONFIGURACI√ìN =================
const firebaseConfig = {
  databaseURL: "https://chat-de-pruebas-default-rtdb.firebaseio.com"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Referencias Firebase
const messagesRef = db.ref("android_chat/messages");
const usersRef = db.ref("android_chat/users");
const onlineRef = db.ref("android_chat/online");

// Variables de estado
let currentUser = null;
let captchaCode = "";
let registerCaptchaCode = "";
let failedAttempts = 0;
let isKeyboardOpen = false;

// ================= INICIALIZACI√ìN =================
document.addEventListener('DOMContentLoaded', initApp);

function initApp() {
  setupViewport();
  setupEventListeners();
  setupCAPTCHA();
  checkSavedSession();
  setupKeyboardDetection();
}

// Ajustar viewport para Android WebView
function setupViewport() {
  const viewport = document.querySelector('meta[name="viewport"]');
  if (window.innerWidth <= 768) {
    viewport.content = "width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no";
  }
}

// Detectar teclado virtual
function setupKeyboardDetection() {
  const visualViewport = window.visualViewport;
  if (visualViewport) {
    visualViewport.addEventListener('resize', () => {
      isKeyboardOpen = visualViewport.height < window.innerHeight;
      document.body.classList.toggle('keyboard-open', isKeyboardOpen);
    });
  }
}

// ================= CAPTCHA =================
function setupCAPTCHA() {
  generateCAPTCHAs();
  
  // Botones de refresco
  document.getElementById('refreshCaptcha').addEventListener('click', () => {
    generateLoginCAPTCHA();
  });
  
  document.getElementById('refreshRegisterCaptcha').addEventListener('click', () => {
    generateRegisterCAPTCHA();
  });
}

function generateCAPTCHAs() {
  generateLoginCAPTCHA();
  generateRegisterCAPTCHA();
}

function generateLoginCAPTCHA() {
  captchaCode = generateRandomCode();
  document.getElementById('captchaDisplay').textContent = captchaCode;
}

function generateRegisterCAPTCHA() {
  registerCaptchaCode = generateRandomCode();
  document.getElementById('registerCaptchaDisplay').textContent = registerCaptchaCode;
}

function generateRandomCode() {
  const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
  let code = "";
  for (let i = 0; i < 5; i++) {
    code += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return code;
}

// ================= EVENT LISTENERS =================
function setupEventListeners() {
  // Tabs
  document.getElementById('loginTab').addEventListener('click', showLoginForm);
  document.getElementById('registerTab').addEventListener('click', showRegisterForm);
  
  // Botones
  document.getElementById('loginBtn').addEventListener('click', handleLogin);
  document.getElementById('registerBtn').addEventListener('click', handleRegister);
  document.getElementById('logoutBtn').addEventListener('click', handleLogout);
  document.getElementById('sendBtn').addEventListener('click', sendMessage);
  
  // Teclado
  document.getElementById('messageInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });
  
  // Auto-expand textarea
  document.getElementById('messageInput').addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
  });
  
  // Enter key hints para m√≥vil
  document.getElementById('loginUser').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') document.getElementById('loginPass').focus();
  });
  
  document.getElementById('loginPass').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') document.getElementById('captchaInput').focus();
  });
  
  document.getElementById('captchaInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') handleLogin();
  });
  
  // Prevenir zoom en inputs
  document.querySelectorAll('input, textarea').forEach(el => {
    el.addEventListener('touchstart', (e) => {
      e.target.style.fontSize = '16px'; // Previene zoom en iOS
    });
  });
}

// ================= UI HELPERS =================
function showLoginForm() {
  document.getElementById('loginTab').classList.add('active');
  document.getElementById('registerTab').classList.remove('active');
  document.getElementById('loginForm').classList.remove('hidden');
  document.getElementById('registerForm').classList.add('hidden');
  clearAlerts();
  generateLoginCAPTCHA();
}

function showRegisterForm() {
  document.getElementById('registerTab').classList.add('active');
  document.getElementById('loginTab').classList.remove('active');
  document.getElementById('registerForm').classList.remove('hidden');
  document.getElementById('loginForm').classList.add('hidden');
  clearAlerts();
  generateRegisterCAPTCHA();
}

function clearAlerts() {
  document.getElementById('loginError').style.display = 'none';
  document.getElementById('registerError').style.display = 'none';
  document.getElementById('registerSuccess').style.display = 'none';
}

function showLoading(buttonId) {
  const btn = document.getElementById(buttonId);
  const text = btn.querySelector(`#${buttonId}Text`);
  const spinner = btn.querySelector(`#${buttonId}Spinner`);
  if (text) text.classList.add('hidden');
  if (spinner) spinner.classList.remove('hidden');
  btn.disabled = true;
}

function hideLoading(buttonId) {
  const btn = document.getElementById(buttonId);
  const text = btn.querySelector(`#${buttonId}Text`);
  const spinner = btn.querySelector(`#${buttonId}Spinner`);
  if (text) text.classList.remove('hidden');
  if (spinner) spinner.classList.add('hidden');
  btn.disabled = false;
}

// ================= AUTENTICACI√ìN =================
function checkSavedSession() {
  const savedUser = localStorage.getItem('android_chat_user');
  if (savedUser) {
    document.getElementById('loginUser').value = savedUser;
    document.getElementById('loginPass').focus();
  }
}

function hashPassword(password) {
  return CryptoJS.SHA256(password).toString();
}

function validateUsername(username) {
  if (!username || username.length < 3 || username.length > 20) return false;
  return /^[a-zA-Z0-9_]+$/.test(username);
}

function validatePassword(password) {
  return password && password.length >= 6;
}

async function handleLogin() {
  const username = document.getElementById('loginUser').value.trim();
  const password = document.getElementById('loginPass').value;
  const captcha = document.getElementById('captchaInput').value.trim().toUpperCase();
  
  // Validaciones b√°sicas
  if (!username || !password || !captcha) {
    showAlert('loginError', 'Completa todos los campos');
    return;
  }
  
  if (captcha !== captchaCode) {
    showAlert('loginError', 'C√≥digo de seguridad incorrecto');
    generateLoginCAPTCHA();
    document.getElementById('captchaInput').value = '';
    failedAttempts++;
    
    if (failedAttempts >= 3) {
      document.getElementById('loginBtn').disabled = true;
      showAlert('loginError', 'Demasiados intentos. Espera 30 segundos.');
      setTimeout(() => {
        document.getElementById('loginBtn').disabled = false;
        failedAttempts = 0;
        generateLoginCAPTCHA();
      }, 30000);
    }
    return;
  }
  
  showLoading('loginBtn');
  
  try {
    // Verificar usuario en Firebase
    const userSnapshot = await usersRef.child(username).once('value');
    
    if (!userSnapshot.exists()) {
      showAlert('loginError', 'Usuario no encontrado');
      generateLoginCAPTCHA();
      return;
    }
    
    const userData = userSnapshot.val();
    const hashedPassword = hashPassword(password);
    
    if (userData.password !== hashedPassword) {
      showAlert('loginError', 'Contrase√±a incorrecta');
      generateLoginCAPTCHA();
      return;
    }
    
    // Iniciar sesi√≥n exitosa
    currentUser = {
      username: username,
      color: userData.color || generateColor(username)
    };
    
    localStorage.setItem('android_chat_user', username);
    failedAttempts = 0;
    
    // Mostrar chat
    showChatScreen();
    
  } catch (error) {
    showAlert('loginError', 'Error de conexi√≥n');
    console.error('Login error:', error);
  } finally {
    hideLoading('loginBtn');
  }
}

async function handleRegister() {
  const username = document.getElementById('registerUser').value.trim();
  const password = document.getElementById('registerPass').value;
  const confirm = document.getElementById('registerConfirm').value;
  const captcha = document.getElementById('registerCaptchaInput').value.trim().toUpperCase();
  
  // Validar CAPTCHA primero
  if (captcha !== registerCaptchaCode) {
    showAlert('registerError', 'C√≥digo de seguridad incorrecto');
    generateRegisterCAPTCHA();
    document.getElementById('registerCaptchaInput').value = '';
    return;
  }
  
  if (!validateUsername(username)) {
    showAlert('registerError', 'Usuario: 3-20 letras, n√∫meros o _');
    generateRegisterCAPTCHA();
    return;
  }
  
  if (!validatePassword(password)) {
    showAlert('registerError', 'Contrase√±a m√≠nimo 6 caracteres');
    generateRegisterCAPTCHA();
    return;
  }
  
  if (password !== confirm) {
    showAlert('registerError', 'Las contrase√±as no coinciden');
    generateRegisterCAPTCHA();
    return;
  }
  
  showLoading('registerBtn');
  
  try {
    // Verificar si el usuario ya existe
    const userSnapshot = await usersRef.child(username).once('value');
    
    if (userSnapshot.exists()) {
      showAlert('registerError', 'Este usuario ya existe');
      generateRegisterCAPTCHA();
      return;
    }
    
    // Crear nuevo usuario
    const hashedPassword = hashPassword(password);
    const userColor = generateColor(username);
    
    await usersRef.child(username).set({
      username: username,
      password: hashedPassword,
      color: userColor,
      created: Date.now()
    });
    
    // Mostrar √©xito
    showAlert('registerSuccess', '¬°Cuenta creada! Redirigiendo...');
    
    // Cambiar a login despu√©s de 2 segundos
    setTimeout(() => {
      showLoginForm();
      document.getElementById('loginUser').value = username;
      document.getElementById('loginPass').focus();
      generateLoginCAPTCHA();
    }, 2000);
    
  } catch (error) {
    showAlert('registerError', 'Error al crear la cuenta');
    console.error('Register error:', error);
  } finally {
    hideLoading('registerBtn');
  }
}

function generateColor(str) {
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    hash = str.charCodeAt(i) + ((hash << 5) - hash);
  }
  return `hsl(${Math.abs(hash % 360)}, 70%, 60%)`;
}

// ================= CHAT =================
function showChatScreen() {
  document.getElementById('loginScreen').classList.add('hidden');
  document.getElementById('chatScreen').classList.remove('hidden');
  
  // Actualizar UI del usuario
  document.getElementById('userBadge').textContent = currentUser.username.charAt(0).toUpperCase();
  document.getElementById('userBadge').style.backgroundColor = currentUser.color;
  
  // Configurar Firebase para el chat
  setupChat();
}

function setupChat() {
  // Presencia en l√≠nea
  const userOnlineRef = onlineRef.child(currentUser.username);
  userOnlineRef.set({
    username: currentUser.username,
    status: 'online',
    lastSeen: Date.now()
  });
  
  userOnlineRef.onDisconnect().set({
    username: currentUser.username,
    status: 'offline',
    lastSeen: Date.now()
  });
  
  // Contador de usuarios en l√≠nea
  onlineRef.on('value', snapshot => {
    const users = snapshot.val() || {};
    const onlineCount = Object.values(users).filter(u => u.status === 'online').length;
    document.getElementById('onlineCount').textContent = onlineCount;
  });
  
  // Cargar mensajes
  messagesRef.limitToLast(50).on('child_added', snapshot => {
    const message = snapshot.val();
    if (message) displayMessage(message);
  });
  
  // Enfocar el input
  setTimeout(() => {
    document.getElementById('messageInput').focus();
  }, 300);
}

function displayMessage(message) {
  const container = document.getElementById('messagesContainer');
  const messageDiv = document.createElement('div');
  
  const isOwn = message.username === currentUser.username;
  const time = formatTime(message.timestamp);
  
  messageDiv.className = `message ${isOwn ? 'own' : 'other'}`;
  messageDiv.innerHTML = `
    <div class="message-info">
      <span class="message-sender" style="color: ${message.color || '#666'}">
        ${escapeHTML(message.username)}
      </span>
      <span class="message-time">${time}</span>
    </div>
    <div class="message-bubble">${escapeHTML(message.text)}</div>
  `;
  
  container.appendChild(messageDiv);
  
  // Scroll suave al √∫ltimo mensaje
  setTimeout(() => {
    container.scrollTo({
      top: container.scrollHeight,
      behavior: 'smooth'
    });
  }, 100);
}

function formatTime(timestamp) {
  if (!timestamp) return '';
  const date = new Date(timestamp);
  return date.toLocaleTimeString('es-CO', {
    hour: '2-digit',
    minute: '2-digit'
  });
}

function sendMessage() {
  const input = document.getElementById('messageInput');
  const text = input.value.trim();
  
  if (!text) return;
  
  // Limitar longitud
  if (text.length > 500) {
    alert('M√°ximo 500 caracteres por mensaje');
    return;
  }
  
  // Enviar a Firebase
  messagesRef.push({
    username: currentUser.username,
    text: text,
    color: currentUser.color,
    timestamp: Date.now()
  });
  
  // Limpiar input
  input.value = '';
  input.style.height = 'auto';
  
  // Enfocar de nuevo
  input.focus();
}

function handleLogout() {
  if (currentUser) {
    onlineRef.child(currentUser.username).remove();
  }
  
  currentUser = null;
  localStorage.removeItem('android_chat_user');
  
  // Volver a login
  document.getElementById('chatScreen').classList.add('hidden');
  document.getElementById('loginScreen').classList.remove('hidden');
  
  // Limpiar chat
  document.getElementById('messagesContainer').innerHTML = '';
  
  // Resetear formulario
  document.getElementById('loginPass').value = '';
  document.getElementById('captchaInput').value = '';
  clearAlerts();
  generateLoginCAPTCHA();
}

// ================= UTILIDADES =================
function showAlert(elementId, message) {
  const element = document.getElementById(elementId);
  element.textContent = message;
  element.style.display = 'block';
}

function escapeHTML(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// ================= EVENTOS DEL TECLADO =================
// Ajustar altura del √°rea de mensajes cuando se abre el teclado
window.addEventListener('resize', () => {
  if (window.innerHeight < 500) {
    document.body.classList.add('keyboard-open');
  } else {
    document.body.classList.remove('keyboard-open');
  }
});

// Prevenir comportamiento por defecto en toques largos
document.addEventListener('touchstart', (e) => {
  if (e.touches.length > 1) {
    e.preventDefault();
  }
}, { passive: false });

// Desplazamiento suave para mensajes
document.getElementById('messagesContainer').addEventListener('touchmove', (e) => {
  e.stopPropagation();
}, { passive: true });

// ================= LIMPIEZA AUTOM√ÅTICA =================
// Limpiar mensajes antiguos cada hora
setInterval(async () => {
  try {
    const snapshot = await messagesRef.once('value');
    const messages = snapshot.val();
    if (!messages) return;
    
    const messageKeys = Object.keys(messages);
    if (messageKeys.length > 100) {
      const messagesToDelete = messageKeys.slice(0, messageKeys.length - 50);
      messagesToDelete.forEach(key => {
        messagesRef.child(key).remove();
      });
    }
  } catch (error) {
    console.error('Error cleaning old messages:', error);
  }
}, 3600000); // Cada hora
</script>

</body>
</html>